import flixel.input.keyboard.FlxKey;

soundBankZero = new FlxTypedGroup();
snd = FlxG.sound.load(Paths.sound("toastybuns/00-0cut"));
soundBankZero.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/00-1heat"));
soundBankZero.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/00-2toast"));
soundBankZero.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/00-3cook"));
soundBankZero.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/00-4cut"));
soundBankZero.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/00-5heat"));
soundBankZero.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/00-6toast"));
soundBankZero.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/00-7cook"));
soundBankZero.add(snd);

soundBankOne = new FlxTypedGroup();
snd = FlxG.sound.load(Paths.sound("toastybuns/01-0cutthe"));
soundBankOne.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/01-1lettuce"));
soundBankOne.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/01-2heatthe"));
soundBankOne.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/01-3grill"));
soundBankOne.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/01-4toastthe"));
soundBankOne.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/01-5buns"));
soundBankOne.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/01-6cookthe"));
soundBankOne.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/01-7patties"));
soundBankOne.add(snd);

soundBankTwo = new FlxTypedGroup();
snd = FlxG.sound.load(Paths.sound("toastybuns/02-0servethe"));
soundBankTwo.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/02-1drinks"));
soundBankTwo.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/02-2meltthe"));
soundBankTwo.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/02-3cheese"));
soundBankTwo.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/02-4frenchthe"));
soundBankTwo.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/02-5fries"));
soundBankTwo.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/02-6sweepthe"));
soundBankTwo.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/02-7floors"));
soundBankTwo.add(snd);

soundBankThree = new FlxTypedGroup();
snd = FlxG.sound.load(Paths.sound("toastybuns/03-0cook"));
soundBankThree.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/03-1those"));
soundBankThree.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/03-2burgers"));
soundBankThree.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/03-3turnthe"));
soundBankThree.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/03-4patty"));
soundBankThree.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/03-5over"));
soundBankThree.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/03-6watch"));
soundBankThree.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/03-7them"));
soundBankThree.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/03-8fries"));
soundBankThree.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/03-9better"));
soundBankThree.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/03-Aexecute"));
soundBankThree.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/03-Bsooner"));
soundBankThree.add(snd);

soundBankFour = new FlxTypedGroup();
snd = FlxG.sound.load(Paths.sound("toastybuns/04-0bring"));
soundBankFour.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/04-1onthe"));
soundBankFour.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/04-2ketchup"));
soundBankFour.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/04-3dontfor"));
soundBankFour.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/04-4getthe"));
soundBankFour.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/04-5cheese"));
soundBankFour.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/04-6bring"));
soundBankFour.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/04-7onthe"));
soundBankFour.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/04-8mustard"));
soundBankFour.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/04-9handle"));
soundBankFour.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/04-Aitwith"));
soundBankFour.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/04-Bease"));
soundBankFour.add(snd);

soundBankFive = new FlxTypedGroup();
snd = FlxG.sound.load(Paths.sound("toastybuns/05-0cook"));
soundBankFive.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/05-1those"));
soundBankFive.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/05-2burgers"));
soundBankFive.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/05-3turnthe"));
soundBankFive.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/05-4patty"));
soundBankFive.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/05-5over"));
soundBankFive.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/05-6cutthe"));
soundBankFive.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/05-7lettuce"));
soundBankFive.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/05-8dontfor"));
soundBankFive.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/05-9getthe"));
soundBankFive.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/05-Acheese"));
soundBankFive.add(snd);

soundBankSix = new FlxTypedGroup();
snd = FlxG.sound.load(Paths.sound("toastybuns/06-0toastthe"));
soundBankSix.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/06-1buns"));
soundBankSix.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/06-2frenchthe"));
soundBankSix.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/06-3fries"));
soundBankSix.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/06-4bring"));
soundBankSix.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/06-5onthe"));
soundBankSix.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/06-6ketchup"));
soundBankSix.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/06-7sweepthe"));
soundBankSix.add(snd);
snd = FlxG.sound.load(Paths.sound("toastybuns/06-8floors"));
soundBankSix.add(snd);

oops = FlxG.sound.load(Paths.sound("oops"));
goodRappin = FlxG.sound.load(Paths.sound("good"));
badRappin = FlxG.sound.load(Paths.sound("bad"));
curSound = oops;
var camNotes:FlxCamera = new FlxCamera(0, 520, 1280, 200);
camNotes.alpha = 1;
playedNotes = new FlxTypedGroup();
ghostNotes = new FlxTypedGroup();
dots = new FlxTypedGroup();
dots.cameras = [camNotes];
acceptingInputs = false;
var border:FlxSprite;
border = new FlxSprite().loadGraphic(Paths.image('border'));
border.scrollFactor.set(0,0);
border.cameras = [camNotes];
border.scale.set(4,4);
border.y = 75;
border.x = 480;
border.visible = true;
border.flipY = !camHUD.downscroll;
add(border);
borderEdge = new FlxSprite().loadGraphic(Paths.image('borderEdge'));
borderEdge.scrollFactor.set(0,0);
borderEdge.cameras = [camNotes];
borderEdge.scale.set(4,4);
borderEdge.y = 74;
borderEdge.x = 480;
borderEdge.visible = true;
borderEdge.flipY = !camHUD.downscroll;
prevBeat = 0;
playerIcon = new FlxSprite().loadGraphic(Paths.image('char icons'),true,20,20);
playerIcon.animation.add("player", [0], 1);
playerIcon.animation.add("teacher", [1], 1);
playerIcon.animation.play("teacher");
playerIcon.cameras = [camNotes];
playerIcon.scale.set(4,4);
playerIconAsWell = new FlxSprite().loadGraphic(Paths.image('char icons'),true,20,20);
playerIconAsWell.animation.add("player", [0], 1);
playerIconAsWell.animation.add("teacher", [1], 1);
playerIconAsWell.animation.play("teacher");
playerIconAsWell.cameras = [camNotes];
playerIconAsWell.scale.set(4,4);
playerIconAlsoAsWell = new FlxSprite().loadGraphic(Paths.image('char icons'),true,20,20);
playerIconAlsoAsWell.animation.add("player", [0], 1);
playerIconAlsoAsWell.animation.add("teacher", [1], 1);
playerIconAlsoAsWell.animation.play("teacher");
playerIconAlsoAsWell.cameras = [camNotes];
playerIconAlsoAsWell.scale.set(4,4);
sndIdx = [0,0,0,0,0,0];
recordedNotes = [];
beatOffset = 0;
recording = false;
function numToSymbol(num) {
	symbols = ['l','s','x','t','c','r'];
	return symbols[num];
}
function sin(val) {
	return Math.sin(Math.PI*val);
}
function flr(val) {
	return Math.floor(val);
}
function sqr(val) {
	return Math.pow(val, 2);
}
function calculateScore(guide, playedAll) {
	freestyleNotes = [];
	sectionScore = 0;
	noteScore = 0;
	guideDiversity = 0;
	playedDiversity = 0;
	funkiness = [3, 7, 5, 7];
	guideNotesArray = [false, false, false, false, false, false];
	playedNotesArray = [false, false, false, false, false, false];
	//if (playedAll[0][0] == guide[0][0])
		//sectionScore += 3;
	for (idx in 0...guide.length) {
		note = guide[idx];
		guideNotesArray[note[0]] = true;
	}
	for (idx in 0...playedAll.length) {
		thisNote = playedAll[idx];
		playedNotesArray[thisNote[0]] = true;
	}
	for (guideIdx in 0...guide.length) {
		guideNote = guide[guideIdx];
		for (playedIdx in 0...playedAll.length) {
			playedNote = playedAll[playedIdx];
			if ((playedNote[0] == guideNote[0]) && (Math.abs(guideNote[1] - playedNote[1]) <= 1)) {
				sectionScore += flr(Math.sqrt(1 - Math.abs(guideNote[1] - playedNote[1]))*8 + 0.5);
				playedNote[2] = true;
				break;
			}
		}
	}
	for (playedIdx in 0...playedAll.length) {
		playedNote = playedAll[playedIdx];
		if (!playedNote[2])
			freestyleNotes.push(playedNote);
	}
	prevNote = null;
	for (freestyleIdx in 0...freestyleNotes.length) {
		freeNote = freestyleNotes[freestyleIdx];
		if (prevNote != null) {
			if (Math.abs(freeNote[1] - prevNote[1]) < 1) {
				sectionScore -= 24 * (1 - Math.abs(freeNote[1] - prevNote[1]));
				trace("penalty for note " + freestyleIdx + ": " + 24 * (1 - Math.abs(freeNote[1] - prevNote[1])));
			}
		}
		prevNote = freeNote;
		noteScore = funkiness[(flr(freeNote[1] + 0.5) % 4) + 1];
		noteScore *= -0.5 * sin(freeNote[2] % 1) + 1;
		if (!guideNotesArray[freeNote[0]]) {
			noteScore *= 0.125;
		}
		sectionScore += flr(noteScore + 0.5);
	}
	for (idx in 0...6) {
		if (guideNotesArray[idx])
			guideDiversity += 1;
	}
	for (idx in 0...6) {
		if (playedNotesArray[idx]) {
			playedDiversity += 1;
		}
	}
	sectionScore *= 1 + ((playedDiversity - guideDiversity) / 2);
	sectionScore -= guide.length * 5;
	if (sectionScore > 0) {
		curSound.stop();
		curSound = goodRappin;
		curSound.play();
		boyfriend.playAnim('hey',true,'SING');
	} else {
		curSound.stop();
		curSound = badRappin;
		curSound.play();
		boyfriend.playAnim('scared',true,'SING');
	}
	trace("score: " + flr(sectionScore + 0.5));
	return flr(sectionScore + 0.5);
}
function postCreate() {
	healthBar.visible = false;
	healthBarBG.visible = false;
	iconP1.visible = false;
	iconP2.visible = false;
	totalScore = 0;
	lastSectionScore = 0;
	lSounds = [];
	sSounds = [];
	xSounds = [];
	tSounds = [];
	cSounds = [];
	rSounds = [];
	FlxG.cameras.add(camNotes, false);
	add(dots);
	add(ghostNotes);
	add(playedNotes);
	for (i in 0...64) {
		if (i%4 == 0) {
			dot = new FlxSprite().loadGraphic(Paths.image('beatDot'));
		} else {
			dot = new FlxSprite().loadGraphic(Paths.image('dot'));
		}
		dot.scrollFactor.set(i%16,flr(i/16));
		dot.scale.set(4,4);
		dot.x = (i%16) * 80 + 22;
		dot.y = flr(i/16) * 80 + 22;
		dot.cameras = [camNotes];
		dots.add(dot);
    }
	add(playerIcon);
	add(playerIconAsWell);
	add(playerIconAlsoAsWell);
	add(borderEdge);
}
function onEvent(eventEvent) {
    if (eventEvent.event.name == "toggleinput") {
        acceptingInputs = !acceptingInputs;
		if (acceptingInputs) {
			playerIcon.animation.play('player');
			playerIconAsWell.animation.play('player');
			playerIconAlsoAsWell.animation.play('player');
		}
    }
    if (eventEvent.event.name == "togglenoteboard") {
        camNotes.alpha = 1 - camNotes.alpha;
    }
    if (eventEvent.event.name == "switchplayer") {
        playerIcon.animation.play(eventEvent.event.params[0]);
        playerIconAsWell.animation.play(eventEvent.event.params[0]);
    }
	if (eventEvent.event.name == "teachernote") {
		icon = new FlxSprite().loadGraphic(Paths.image('play icons'),true,20,20);
		icon.animation.add("l", [0], 1);
		icon.animation.add("s", [1], 1);
		icon.animation.add("x", [2], 1);
		icon.animation.add("t", [3], 1);
		icon.animation.add("c", [4], 1);
		icon.animation.add("r", [5], 1);
		icon.animation.play(eventEvent.event.params[0]);
		switch(eventEvent.event.params[0]) {
			case "l": {
				dad.playAnim('singLEFT',true,'SING');
			};
			case "s": {
				dad.playAnim('singLEFT',true,'SING');
			};
			case "x": {
				dad.playAnim('singDOWN',true,'SING');
			};
			case "t": {
				dad.playAnim('singUP',true,'SING');
			};
			case "c": {
				dad.playAnim('singRIGHT',true,'SING');
			};
			case "r": {
				dad.playAnim('singRIGHT',true,'SING');
			};
		}
		fixedBeat = eventEvent.event.params[1] * 4;
		icon.x = (((fixedBeat / 4) + 0.07) % 4) * 320;
		icon.y = playerIcon.y;
		icon.scrollFactor.set(((fixedBeat / 4) + 0.07),flr((fixedBeat + 0.07)/16));
		icon.cameras = [camNotes];
		icon.scale.set(4,4);
		icon.alpha = 0.75;
		playedNotes.add(icon);
        playerIcon.animation.play('teacher');
        playerIconAsWell.animation.play('teacher');
        playerIconAlsoAsWell.animation.play('teacher');
	}
	if (eventEvent.event.name == "ghostnote") {
		icon = new FlxSprite().loadGraphic(Paths.image('still icons'),true,20,20);
		icon.animation.add("l", [0], 1);
		icon.animation.add("s", [1], 1);
		icon.animation.add("x", [2], 1);
		icon.animation.add("t", [3], 1);
		icon.animation.add("c", [4], 1);
		icon.animation.add("r", [5], 1);
		icon.animation.play(eventEvent.event.params[0]);
		fixedBeat = eventEvent.event.params[1] * 4;
		icon.x = (((fixedBeat / 4) + 0.07) % 4) * 320;
		icon.y = playerIcon.y;
		icon.scrollFactor.set(0.07,flr((fixedBeat + 0.07) / 16));
		icon.cameras = [camNotes];
		icon.scale.set(4,4);
		ghostNotes.add(icon);
	}
	if (eventEvent.event.name == "recordnotes") {
		recordedNotes = [];
		beatOffset = eventEvent.event.params[0];
		recording = true;
	}
	if (eventEvent.event.name == "scoreupdate") {
		trace(Std.int(eventEvent.event.params[0]));
		if (recordedNotes.length > 0) {
			lastSectionScore = calculateScore(guides[Std.int(eventEvent.event.params[0])], recordedNotes);
		} else {
			lastSectionScore = guides[Std.int(eventEvent.event.params[0])].length * -4;
		}
		totalScore += lastSectionScore;
		recording = false;
	}
	if (eventEvent.event.name == "switchsounds") {
		switch(eventEvent.event.params[0]) {
			case "-1": {
				lSounds = [];
				sSounds = [];
				xSounds = [];
				tSounds = [];
				cSounds = [];
				rSounds = [];
			}
			case "0": {
				lSounds = [];
				sSounds = [];
				xSounds = [];
				tSounds = [soundBankZero.members[0]];
				cSounds = [soundBankZero.members[1]];
				rSounds = [];
			};
			case "1": {
				lSounds = [];
				sSounds = [soundBankZero.members[3]];
				xSounds = [soundBankZero.members[2]];
				tSounds = [];
				cSounds = [];
				rSounds = [];
			};
			case "2": {
				lSounds = [];
				sSounds = [];
				xSounds = [];
				tSounds = [soundBankZero.members[4]];
				cSounds = [soundBankZero.members[5]];
				rSounds = [];
			};
			case "3": {
				lSounds = [];
				sSounds = [soundBankZero.members[7]];
				xSounds = [soundBankZero.members[6]];
				tSounds = [];
				cSounds = [];
				rSounds = [];
			};
			case "4": {
				lSounds = [];
				sSounds = [];
				xSounds = [];
				tSounds = [soundBankOne.members[0]];
				cSounds = [soundBankOne.members[1]];
				rSounds = [];
			};
			case "5": {
				lSounds = [];
				sSounds = [];
				xSounds = [soundBankOne.members[3]];
				tSounds = [];
				cSounds = [soundBankOne.members[2]];
				rSounds = [];
			};
			case "6": {
				lSounds = [];
				sSounds = [soundBankOne.members[5]];
				xSounds = [soundBankOne.members[4]];
				tSounds = [];
				cSounds = [];
				rSounds = [];
			};
			case "7": {
				lSounds = [];
				sSounds = [soundBankOne.members[6]];
				xSounds = [];
				tSounds = [soundBankOne.members[7]];
				cSounds = [];
				rSounds = [];
			};
		};
		sndIdx = [0,0,0,0,0,0];
	}
}
function doCoolerEvent(e) {
    if (e[0] == "toggleinput") {
		trace("inputs toggled");
        acceptingInputs = !acceptingInputs;
		if (acceptingInputs) {
			playerIcon.animation.play('player');
			playerIconAsWell.animation.play('player');
			playerIconAlsoAsWell.animation.play('player');
		}
    }
    if (e[0] == "togglenoteboard") {
        camNotes.alpha = 1 - camNotes.alpha;
    }
    if (e[0] == "switchplayer") {
        playerIcon.animation.play(e[1][0]);
        playerIconAsWell.animation.play(e[1][0]);
    }
	if (e[0] == "teachernote") {
		icon = new FlxSprite().loadGraphic(Paths.image('play icons'),true,20,20);
		icon.animation.add("l", [0], 1);
		icon.animation.add("s", [1], 1);
		icon.animation.add("x", [2], 1);
		icon.animation.add("t", [3], 1);
		icon.animation.add("c", [4], 1);
		icon.animation.add("r", [5], 1);
		icon.animation.play(e[1][0]);
		switch(e[1][0]) {
			case "l": {
				dad.playAnim('singLEFT',true,'SING');
			};
			case "s": {
				dad.playAnim('singLEFT',true,'SING');
			};
			case "x": {
				dad.playAnim('singDOWN',true,'SING');
			};
			case "t": {
				dad.playAnim('singUP',true,'SING');
			};
			case "c": {
				dad.playAnim('singRIGHT',true,'SING');
			};
			case "r": {
				dad.playAnim('singRIGHT',true,'SING');
			};
		}
		fixedBeat = e[1][1] * 4;
		icon.x = (((fixedBeat / 4) + 0.07) % 4) * 320;
		icon.y = playerIcon.y;
		icon.scrollFactor.set(((fixedBeat / 4) + 0.07),flr((fixedBeat + 0.07)/16));
		icon.cameras = [camNotes];
		icon.scale.set(4,4);
		icon.alpha = 1;
		playedNotes.add(icon);
        playerIcon.animation.play('teacher');
        playerIconAsWell.animation.play('teacher');
        playerIconAlsoAsWell.animation.play('teacher');
	}
	if (e[0] == "ghostnote") {
		trace("trying to create ghost note");
		icon = new FlxSprite().loadGraphic(Paths.image('still icons'),true,20,20);
		icon.animation.add("l", [0], 1);
		icon.animation.add("s", [1], 1);
		icon.animation.add("x", [2], 1);
		icon.animation.add("t", [3], 1);
		icon.animation.add("c", [4], 1);
		icon.animation.add("r", [5], 1);
		icon.animation.play(e[1][0]);
		fixedBeat = e[1][1] * 4;
		icon.x = (((fixedBeat / 4) + 0.07) % 4) * 320;
		icon.y = playerIcon.y;
		icon.scrollFactor.set(0.07,flr((fixedBeat + 0.07) / 16));
		icon.cameras = [camNotes];
		icon.scale.set(4,4);
		ghostNotes.add(icon);
		trace("created a ghost "+e[1][0]+" note at beat "+e[1][1] * 4);
	}
	if (e[0] == "recordnotes") {
		recordedNotes = [];
		beatOffset = e[1][0];
		recording = true;
	}
	if (e[0] == "scoreupdate") {
		trace(Std.int(e[1][0]));
		if (recordedNotes.length > 0) {
			lastSectionScore = calculateScore(guides[Std.int(e[1][0])], recordedNotes);
		} else {
			lastSectionScore = guides[Std.int(e[1][0])].length * -4;
		}
		totalScore += lastSectionScore;
		recording = false;
	}
	if (e[0] == "switchsounds") {
		switch(e[1][0]) {
			case "-1": {
				lSounds = [];
				sSounds = [];
				xSounds = [];
				tSounds = [];
				cSounds = [];
				rSounds = [];
			}
			case "0": {
				lSounds = [];
				sSounds = [];
				xSounds = [];
				tSounds = [soundBankZero.members[0]];
				cSounds = [];
				rSounds = [];
			};
			case "1": {
				lSounds = [];
				sSounds = [];
				xSounds = [];
				tSounds = [];
				cSounds = [soundBankZero.members[1]];
				rSounds = [];
			};
			case "2": {
				lSounds = [];
				sSounds = [];
				xSounds = [soundBankZero.members[2]];
				tSounds = [];
				cSounds = [];
				rSounds = [];
			};
			case "3": {
				lSounds = [];
				sSounds = [soundBankZero.members[3]];
				xSounds = [];
				tSounds = [];
				cSounds = [];
				rSounds = [];
			};
			case "4": {
				lSounds = [];
				sSounds = [];
				xSounds = [];
				tSounds = [soundBankZero.members[4]];
				cSounds = [];
				rSounds = [];
			};
			case "5": {
				lSounds = [];
				sSounds = [];
				xSounds = [];
				tSounds = [];
				cSounds = [soundBankZero.members[5]];
				rSounds = [];
			};
			case "6": {
				lSounds = [];
				sSounds = [];
				xSounds = [soundBankZero.members[6]];
				tSounds = [];
				cSounds = [];
				rSounds = [];
			};
			case "7": {
				lSounds = [];
				sSounds = [soundBankZero.members[7]];
				xSounds = [];
				tSounds = [];
				cSounds = [];
				rSounds = [];
			};
			case "8": {
				lSounds = [];
				sSounds = [];
				xSounds = [];
				tSounds = [soundBankOne.members[0]];
				cSounds = [soundBankOne.members[1]];
				rSounds = [];
			};
			case "9": {
				lSounds = [];
				sSounds = [];
				xSounds = [soundBankOne.members[3]];
				tSounds = [];
				cSounds = [soundBankOne.members[2]];
				rSounds = [];
			};
			case "10": {
				lSounds = [];
				sSounds = [soundBankOne.members[5]];
				xSounds = [soundBankOne.members[4]];
				tSounds = [];
				cSounds = [];
				rSounds = [];
			};
			case "11": {
				lSounds = [];
				sSounds = [soundBankOne.members[6]];
				xSounds = [];
				tSounds = [soundBankOne.members[7]];
				cSounds = [];
				rSounds = [];
			};
			case "12": {
				lSounds = [];
				sSounds = [];
				xSounds = [soundBankTwo.members[1]];
				tSounds = [soundBankTwo.members[0]];
				cSounds = [];
				rSounds = [];
			};
			case "13": {
				lSounds = [];
				sSounds = [];
				xSounds = [soundBankTwo.members[2]];
				tSounds = [soundBankTwo.members[3]];
				cSounds = [];
				rSounds = [];
			};
			case "14": {
				lSounds = [];
				sSounds = [soundBankTwo.members[5]];
				xSounds = [];
				tSounds = [];
				cSounds = [soundBankTwo.members[4]];
				rSounds = [];
			};
			case "15": {
				lSounds = [];
				sSounds = [soundBankTwo.members[6]];
				xSounds = [];
				tSounds = [];
				cSounds = [soundBankTwo.members[7]];
				rSounds = [];
			};
			case "16": {
				lSounds = [];
				sSounds = [];
				xSounds = [];
				tSounds = [soundBankThree.members[0],soundBankThree.members[1]];
				cSounds = [soundBankThree.members[2]];
				rSounds = [];
			};
			case "17": {
				lSounds = [];
				sSounds = [];
				xSounds = [soundBankThree.members[5]];
				tSounds = [];
				cSounds = [soundBankThree.members[3],soundBankThree.members[4]];
				rSounds = [];
			};
			case "18": {
				lSounds = [];
				sSounds = [soundBankThree.members[8]];
				xSounds = [soundBankThree.members[6],soundBankThree.members[7]];
				tSounds = [];
				cSounds = [];
				rSounds = [];
			};
			case "19": {
				lSounds = [];
				sSounds = [soundBankThree.members[9],soundBankThree.members[10]];
				xSounds = [];
				tSounds = [soundBankThree.members[11]];
				cSounds = [];
				rSounds = [];
			};
			case "20": {
				lSounds = [];
				sSounds = [];
				xSounds = [soundBankFour.members[2]];
				tSounds = [soundBankFour.members[0],soundBankFour.members[1]];
				cSounds = [];
				rSounds = [];
			};
			case "21": {
				lSounds = [];
				sSounds = [soundBankFour.members[5]];
				xSounds = [];
				tSounds = [];
				cSounds = [soundBankFour.members[3],soundBankFour.members[4]];
				rSounds = [];
			};
			case "22": {
				lSounds = [];
				sSounds = [];
				xSounds = [soundBankFour.members[8]];
				tSounds = [soundBankFour.members[6],soundBankFour.members[7]];
				cSounds = [];
				rSounds = [];
			};
			case "23": {
				lSounds = [];
				sSounds = [soundBankFour.members[11]];
				xSounds = [];
				tSounds = [];
				cSounds = [soundBankFour.members[9],soundBankFour.members[10]];
				rSounds = [];
			};
			case "24": {
				lSounds = [];
				sSounds = [];
				xSounds = [soundBankFive.members[5]];
				tSounds = [soundBankFive.members[0],soundBankFive.members[1]];
				cSounds = [soundBankFive.members[2],soundBankFive.members[3],soundBankFive.members[4]];
				rSounds = [];
			};
			case "25": {
				lSounds = [];
				sSounds = [soundBankFive.members[7],soundBankFive.members[8],soundBankFive.members[9]];
				xSounds = [soundBankFive.members[6]];
				tSounds = [soundBankFive.members[10]];
				cSounds = [];
				rSounds = [];
			};
			case "26": {
				lSounds = [];
				sSounds = [soundBankSix.members[1],soundBankSix.members[2]];
				xSounds = [soundBankSix.members[3]];
				tSounds = [soundBankSix.members[0]];
				cSounds = [];
				rSounds = [];
			};
			case "27": {
				lSounds = [];
				sSounds = [];
				xSounds = [soundBankSix.members[4],soundBankSix.members[5]];
				tSounds = [soundBankSix.members[8]];
				cSounds = [soundBankSix.members[6],soundBankSix.members[7]];
				rSounds = [];
			};
		};
		sndIdx = [0,0,0,0,0,0];
	}
}
function createGhostSection(section, beat) {
	trace("trying createGhostSection("+section+","+beat+")");
	for (idx in 0...guides[section].length) {
		doCoolerEvent(["ghostnote",[numToSymbol(guides[section][idx][0]), beat + (guides[section][idx][1]/4)]]);
	}
}
function parseTeacherSection(section, beat) {
	trace("trying parseTeacherSection("+section+","+beat+")");
	for (idx in 0...guides[section].length) {
		teacherPlayingNotes.push([numToSymbol(guides[section][idx][0]), beat + (guides[section][idx][1]/4)]);
	}
}
guides = [
	[[3,0]],
	[[4,0]],
	[[2,0]],
	[[1,0]],
	[[3,0],[4,4]],
	[[4,0],[2,4]],
	[[2,0],[1,4]],
	[[1,0],[3,4]],
	[[3,0],[2,4]],
	[[2,0],[3,4]],
	[[4,0],[1,4]],
	[[1,0],[4,4]],
	[[3,0],[3,2],[4,4]],
	[[4,0],[4,2],[2,4]],
	[[2,0],[2,2],[1,4]],
	[[1,0],[1,2],[3,6]],
	[[3,0],[3,2],[2,4]],
	[[4,0],[4,2],[1,4]],
	[[3,0],[3,2],[4,4],[4,8],[4,10],[2,12]],
	[[2,0],[1,4],[1,8],[1,10],[3,12]],
	[[3,0],[1,4],[1,8],[2,12]],
	[[2,0],[2,2],[4,4],[4,8],[3,12]]
];
ghostNoteSections = [
	[0,36,true],[0,40,true],
	[1,44,true],[1,48,true],
	[2,52,true],[2,56,true],
	[3,60,true],[3,64,true],
	[0,68,true],[0,72,true],
	[1,76,true],[1,80,true],
	[2,84,true],[2,88,true],
	[3,92,true],[3,96,true],
	[4,116,true],[4,120,true],
	[5,124,true],[5,128,true],
	[6,132,true],[6,136,true],
	[7,140,true],[7,144,true],
	[8,148,true],[8,152,true],
	[9,156,true],[9,160,true],
	[10,164,true],[10,168,true],
	[11,172,true],[11,176,true],
	[12,196,true],[12,200,true],
	[13,204,true],[13,208,true],
	[14,212,true],[14,216,true],
	[15,220-0.5,true],[15,224-0.5,true],
	[16,228,true],[16,230,true],
	[17,232,true],[17,234,true],
	[16,236,true],[16,238,true],
	[17,240,true],[17,242,true],
	[18,260,true],[18,264,true],
	[19,268,true],[19,272,true],
	[20,276,true],[20,280,true],
	[21,284,true],[21,288,true]
];
teacherNoteSections = [
	[0,36,true],
	[1,44,true],
	[2,52,true],
	[3,60,true],
	[0,68,true],
	[1,76,true],
	[2,84,true],
	[3,92,true],
	[4,116,true],
	[5,124,true],
	[6,132,true],
	[7,140,true],
	[8,148,true],
	[9,156,true],
	[10,164,true],
	[11,172,true],
	[12,196,true],
	[13,204,true],
	[14,212,true],
	[15,220-0.5,true],
	[16,228,true],
	[17,232,true],
	[16,236,true],
	[17,240,true],
	[18,260,true],
	[19,268,true],
	[20,276,true],
	[21,284,true]
];
teacherPlayingNotes = [];
playerToggles = [
	          [40-0.5,true],
	[44,true],[48-0.5,true],
	[52,true],[56-0.5,true],
	[60,true],[64-0.5,true],
	[68,true],[72-0.5,true],
	[76,true],[80-0.5,true],
	[84,true],[88-0.5,true],
	[92,true],[96-0.5,true],
	[100,true],[120-0.5,true],
	[124,true],[128-0.5,true],
	[132,true],[136-0.5,true],
	[140,true],[144-0.5,true],
	[148,true],[152-0.5,true],
	[156,true],[160-0.5,true],
	[164,true],[168-0.5,true],
	[172,true],[176-0.5,true],
	[180,true],[200-0.5,true],
	[204,true],[208-0.5,true],
	[212,true],[216-0.5,true],
	[220-0.5,true],[224-1,true],
	[228,true],[230-0.5,true],
	[232,true],[234-0.5,true],
	[236,true],[238-0.5,true],
	[240,true],[242-0.5,true],
	[244,true],[264-0.5,true],
	[268,true],[272-0.5,true],
	[276,true],[280-0.5,true],
	[284,true],[288-0.5,true],
	[292,true]
];
recordingToggles = [
	[40-0.5,40,true],
	[48-0.5,48,true],
	[56-0.5,56,true],
	[64-0.5,64,true],
	[72-0.5,72,true],
	[80-0.5,80,true],
	[88-0.5,88,true],
	[96-0.5,96,true],
	[120-0.5,120,true],
	[128-0.5,128,true],
	[136-0.5,136,true],
	[144-0.5,144,true],
	[152-0.5,152,true],
	[160-0.5,160,true],
	[168-0.5,168,true],
	[176-0.5,176,true],
	[200-0.5,200,true],
	[208-0.5,208,true],
	[216-0.5,216,true],
	[224-1,224-0.5,true],
	[230-0.5,230,true],
	[234-0.5,234,true],
	[238-0.5,238,true],
	[242-0.5,242,true],
	[264-0.5,264,true],
	[272-0.5,272,true],
	[280-0.5,280,true],
	[288-0.5,288,true]
];
soundChanges = [
	[0,-1,true],
	[40-1,0,true],
	[48-1,1,true],
	[56-1,2,true],
	[64-1,3,true],
	[72-1,4,true],
	[80-1,5,true],
	[88-1,6,true],
	[96-1,7,true],
	[120-1,8,true],
	[128-1,9,true],
	[136-1,10,true],
	[144-1,11,true],
	[152-1,12,true],
	[160-1,13,true],
	[168-1,14,true],
	[176-1,15,true],
	[200-1,16,true],
	[208-1,17,true],
	[216-1,18,true],
	[224-1.5,19,true],
	[230-1,20,true],
	[234-1,21,true],
	[238-1,22,true],
	[242-1,23,true],
	[264-1,24,true],
	[272-1,25,true],
	[280-1,26,true],
	[288-1,27,true]
];
scoreUpdates = [
	[0,44,true],
	[1,52,true],
	[2,60,true],
	[3,68,true],
	[0,76,true],
	[1,84,true],
	[2,92,true],
	[3,100,true],
	[4,124,true],
	[5,132,true],
	[6,140,true],
	[7,148,true],
	[8,156,true],
	[9,164,true],
	[10,172,true],
	[11,180,true],
	[12,204,true],
	[13,212,true],
	[14,220-0.5,true],
	[15,228,true],
	[16,232,true],
	[17,236,true],
	[16,240,true],
	[17,244,true],
	[18,268,true],
	[19,276,true],
	[20,284,true],
	[21,292,true]
];
function postUpdate() {
	beatFix = curBeatFloat + 0.14;
	for (idx in 0...ghostNoteSections.length) {
		if (ghostNoteSections[idx][2]) {
			if (ghostNoteSections[idx][1] > beatFix + 16) {
				break;
			}
			trace("creating ghost section for section "+ghostNoteSections[idx][0]+", index "+idx);
			createGhostSection(ghostNoteSections[idx][0],ghostNoteSections[idx][1]);
			ghostNoteSections[idx][2] = false;
		}
	}
	for (idx in 0...playerToggles.length) {
		if (playerToggles[idx][1]) {
			if (playerToggles[idx][0] > beatFix) {
				break;
			}
			trace("toggling inputs");
			doCoolerEvent(["toggleinput"]);
			playerToggles[idx][1] = false;
		}
	}
	for (idx in 0...recordingToggles.length) {
		if (recordingToggles[idx][2]) {
			if (recordingToggles[idx][0] > beatFix) {
				break;
			}
			trace("toggling recording");
			doCoolerEvent(["recordnotes",[recordingToggles[idx][1]]]);
			recordingToggles[idx][2] = false;
		}
	}
	for (idx in 0...scoreUpdates.length) {
		if (scoreUpdates[idx][2]) {
			if (scoreUpdates[idx][1] > beatFix) {
				break;
			}
			trace("scoring");
			doCoolerEvent(["scoreupdate",[scoreUpdates[idx][0]]]);
			scoreUpdates[idx][2] = false;
		}
	}
	for (idx in 0...soundChanges.length) {
		if (soundChanges[idx][2]) {
			if (soundChanges[idx][0] > beatFix) {
				break;
			}
			doCoolerEvent(["switchsounds",[Std.string(soundChanges[idx][1])]]);
			soundChanges[idx][2] = false;
		}
	}
	for (idx in 0...teacherNoteSections.length) {
		if (teacherNoteSections[idx][2]) {
			if (teacherNoteSections[idx][1] > beatFix + 8) {
				break;
			}
			parseTeacherSection(teacherNoteSections[idx][0],teacherNoteSections[idx][1]);
			teacherNoteSections[idx][2] = false;
		}
	}
	for (idx in 0...teacherPlayingNotes.length) {
		if (teacherPlayingNotes[0][1] > beatFix) {
			break;
		}
		doCoolerEvent(["teachernote",[teacherPlayingNotes[0][0], teacherPlayingNotes[0][1]]]);
		teacherPlayingNotes.shift();
		break;
	}
	notesCount = 0;
	for (i in 0...64) {
		dot = dots.members[i];
		dot.y = dot.scrollFactor.y * 80 + 22 + (prevBeat - (beatFix / 4)) * 80;
		if (dot.y < 22 - 80) {
			prevBeat = flr(beatFix / 4);
		}
		dot.y = dot.scrollFactor.y * 80 + 22 + (prevBeat - (beatFix / 4)) * 80;
	}
	playerIcon.y = 102 + (prevBeat - (beatFix / 4)) * 80;
	playerIcon.x = (beatFix % 4) * 320;
	playerIconAsWell.y = 182 + (prevBeat - (beatFix / 4)) * 80;
	playerIconAsWell.x = (beatFix % 4) * 320 - 1280;
	playerIconAlsoAsWell.y = 22 + (prevBeat - (beatFix / 4)) * 80;
	playerIconAlsoAsWell.x = (beatFix % 4) * 320 + 1280;
	if (playedNotes.length > 0) {
		for (i in 0...playedNotes.length) {
			note = playedNotes.members[i];
			if (note != null) {
				note.y = 102 + (note.scrollFactor.y - (beatFix / 4)) * 80;
				if (beatFix - note.scrollFactor.x < 0.5) {
					note.scale.set(8 - ((beatFix - note.scrollFactor.x) * 8), 8 - ((beatFix - note.scrollFactor.x) * 8));
				} else {
					note.scale.set(4,4);
				}
				if (note.y < 22 - 80) {
					note.visible = false;
					playedNotes.remove(note);
					note.destroy();
				} else {
					note.y = 102 + (note.scrollFactor.y - (beatFix / 4)) * 80;
					notesCount += 1;
				}
			}
		}
	}
	if (ghostNotes.length > 0) {
		for (i in 0...ghostNotes.length) {
			note = ghostNotes.members[i];
			if (note != null) {
				note.y = 102 + (note.scrollFactor.y - (beatFix / 4)) * 80;
				if ((note.scrollFactor.y * 4) < beatFix - 32) {
					note.visible = false;
					ghostNotes.remove(note);
					note.destroy();
				} else {
					note.y = 102 + (note.scrollFactor.y - (beatFix / 4)) * 80;
					notesCount += 1;
				}
			}
		}
	}

	if (acceptingInputs) {
		if (FlxG.keys.justPressed.Z) {
			// L - Left
			icon = new FlxSprite().loadGraphic(Paths.image('play icons'),true,20,20);
			icon.animation.add("l", [0], 1);
			icon.animation.play("l");
			icon.x = (beatFix % 4) * 320;
			icon.y = playerIcon.y;
			icon.scrollFactor.set(beatFix,flr(beatFix/4));
			icon.cameras = [camNotes];
			icon.scale.set(4,4);
			playedNotes.add(icon);
			curSound.stop();
			if (lSounds.length == 0) {
				curSound = oops;
				curSound.play();
				boyfriend.playAnim('singLEFTmiss',true,'SING');
			} else {
				curSound = lSounds[sndIdx[0]];
				curSound.play();
				sndIdx[0] += 1;
				sndIdx[0] %= lSounds.length;
				boyfriend.playAnim('singLEFT',true,'SING');
			}
			if (recording) {
				recordedNotes.push([0, (curBeatFloat + 0.07 - beatOffset) * 4, false]);
			}
		}
		if (FlxG.keys.justPressed.X) {
			// S - Square
			icon = new FlxSprite().loadGraphic(Paths.image('play icons'),true,20,20);
			icon.animation.add("s", [1], 1);
			icon.animation.play("s");
			icon.x = (beatFix % 4) * 320;
			icon.y = playerIcon.y;
			icon.scrollFactor.set(beatFix,flr(beatFix/4));
			icon.cameras = [camNotes];
			icon.scale.set(4,4);
			playedNotes.add(icon);
			curSound.stop();
			if (sSounds.length == 0) {
				curSound = oops;
				curSound.play();
				boyfriend.playAnim('singLEFTmiss',true,'SING');
			} else {
				curSound = sSounds[sndIdx[1]];
				curSound.play();
				sndIdx[1] += 1;
				sndIdx[1] %= sSounds.length;
				boyfriend.playAnim('singLEFT',true,'SING');
			}
			if (recording) {
				recordedNotes.push([1, (curBeatFloat + 0.07 - beatOffset) * 4, false]);
			}
		}
		if (FlxG.keys.justPressed.C) {
			// X - Cross
			icon = new FlxSprite().loadGraphic(Paths.image('play icons'),true,20,20);
			icon.animation.add("x", [2], 1);
			icon.animation.play("x");
			icon.x = (beatFix % 4) * 320;
			icon.y = playerIcon.y;
			icon.scrollFactor.set(beatFix,flr(beatFix/4));
			icon.cameras = [camNotes];
			icon.scale.set(4,4);
			playedNotes.add(icon);
			curSound.stop();
			if (xSounds.length == 0) {
				curSound = oops;
				curSound.play();
				boyfriend.playAnim('singDOWNmiss',true,'SING');
			} else {
				curSound = xSounds[sndIdx[2]];
				curSound.play();
				sndIdx[2] += 1;
				sndIdx[2] %= xSounds.length;
				boyfriend.playAnim('singDOWN',true,'SING');
			}
			if (recording) {
				recordedNotes.push([2, (curBeatFloat + 0.07 - beatOffset) * 4, false]);
			}
		}
		if (FlxG.keys.justPressed.B) {
			// T - Triangle
			icon = new FlxSprite().loadGraphic(Paths.image('play icons'),true,20,20);
			icon.animation.add("t", [3], 1);
			icon.animation.play("t");
			icon.x = (beatFix % 4) * 320;
			icon.y = playerIcon.y;
			icon.scrollFactor.set(beatFix,flr(beatFix/4));
			icon.cameras = [camNotes];
			icon.scale.set(4,4);
			playedNotes.add(icon);
			curSound.stop();
			if (tSounds.length == 0) {
				curSound = oops;
				curSound.play();
				boyfriend.playAnim('singUPmiss',true,'SING');
			} else {
				curSound = tSounds[sndIdx[3]];
				curSound.play();
				sndIdx[3] += 1;
				sndIdx[3] %= tSounds.length;
				boyfriend.playAnim('singUP',true,'SING');
			}
			if (recording) {
				recordedNotes.push([3, (curBeatFloat + 0.07 - beatOffset) * 4, false]);
			}
		}
		if (FlxG.keys.justPressed.N) {
			// C - Circle
			icon = new FlxSprite().loadGraphic(Paths.image('play icons'),true,20,20);
			icon.animation.add("c", [4], 1);
			icon.animation.play("c");
			icon.x = (beatFix % 4) * 320;
			icon.y = playerIcon.y;
			icon.scrollFactor.set(beatFix,flr(beatFix/4));
			icon.cameras = [camNotes];
			icon.scale.set(4,4);
			playedNotes.add(icon);
			curSound.stop();
			if (cSounds.length == 0) {
				curSound = oops;
				curSound.play();
				boyfriend.playAnim('singRIGHTmiss',true,'SING');
			} else {
				curSound = cSounds[sndIdx[4]];
				curSound.play();
				sndIdx[4] += 1;
				sndIdx[4] %= cSounds.length;
				boyfriend.playAnim('singRIGHT',true,'SING');
			}
			if (recording) {
				recordedNotes.push([4, (curBeatFloat + 0.07 - beatOffset) * 4, false]);
			}
		}
		if (FlxG.keys.justPressed.M) {
			// R - Right
			icon = new FlxSprite().loadGraphic(Paths.image('play icons'),true,20,20);
			icon.animation.add("r", [5], 1);
			icon.animation.play("r");
			icon.x = (beatFix % 4) * 320;
			icon.y = playerIcon.y;
			icon.scrollFactor.set(beatFix,flr(beatFix/4));
			icon.cameras = [camNotes];
			icon.scale.set(4,4);
			playedNotes.add(icon);
			curSound.stop();
			if (rSounds.length == 0) {
				curSound = oops;
				curSound.play();
				boyfriend.playAnim('singRIGHTmiss',true,'SING');
			} else {
				curSound = rSounds[sndIdx[5]];
				curSound.play();
				sndIdx[5] += 1;
				sndIdx[5] %= rSounds.length;
				boyfriend.playAnim('singRIGHT',true,'SING');
			}
			if (recording) {
				recordedNotes.push([5, (curBeatFloat + 0.07 - beatOffset) * 4, false]);
			}
		}
	}
	missesTxt.text = playedNotes.length;
	scoreTxt.text = totalScore;
	accuracyTxt.text = lastSectionScore;
}